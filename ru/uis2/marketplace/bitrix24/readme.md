# Интеграция с Битрикс24<br />

## ВАЖНО! <br />
* Для корректной работы интеграции, необходимо, чтобы у каждого сотрудника было занесено поле "Фамилия" в профиле портала Битрикс24<br />
* Не забудьте установить приложение "***[UIS - ОМНИканальная система для управления коммуникациями](https://comagic.bitrix24.ru/market/detail/novosystem.omni/)***" в маркетплейсе Битрикс24 <br />

____

## После активации вам открыты следующие разделы и их особенности:<br /><br />

### Главная<br /><br />

- Делает возможной работу всех остальных разделов интеграции;<br />
- Синхронизация сотрудников нашего ЛК и CRM Bitrix24;<br /><br />
### Открытые Линии: чаты<br />

- Доступ к работе чатов через Открытые Линии (появление раздела "OMNI" в контакт-центра B24;<br /><br />


### Открытые Линии: сквозная аналитики<br />

- Позволяет настроить передачу чатов из онлайн-виджета и месседжеров Битрикс24 в наш сервис для дальнейшего анализа эффективности рекламы. <br /><br />

### Чаты<br />

- Настройка основной логики создания сущностей B24 при появлении новых диалогов;<br />
- Логика добавления переписки в ряд сущностей по определенным условиям;<br />
- Назначение ответственных за сущности в B24 по умолчанию или при заданных параметрах фильтра;<br />
- Логика добавления переписки в ряд сущностей по определенным условиям;<br />
- Выбор каналов коммуникации из нашего ЛК, для дальнейшей передачи сообщений и диалогов из выбранного списка каналов;<br />
- Наименование создаваемых сущностей с помощью гибкой настройки шаблонов названий;<br />
- Передача различной информации в дополнительные поля B24;<br />
- Выбор воронок и этапов для создаваемых сущностей;<br />
- Фильтрация обращений;<br /><br />

### Оффлайн заявки<br />

- Имеют идентичную функциональность в настройках, по аналогии с разделом "Чаты"<br /><br />
____
## Настройка интеграции<br />
<details>
  <summary style="font-weight:bold;"> Установка </summary> <br />

Существует два способа установки интеграции с Битрикс24:<br />

1. Установить интеграцию через ***[Личный кабинет UIS](https://go.uiscom.ru/marketplace/integration_list/bitrix24)***, нажав кнопку "Подключить интеграцию".<br />
    - Далее необходимо завести учетные данные: название (может быть любым) и адрес вашего портала Битрикс24.<br />

2. Из маркетплейса ***[Битрикс24](https://comagic.bitrix24.ru/market/detail/novosystem.omni/)***.</br>
   
    - После установки приложения откроется окно с приглашением завершить установку в ЛК UIS.
    - При установке из маркетплейса Битрикс24 заводить учетные данные не нужно, они будут созданы автоматически.<br /><br />
</details>
<details>
  <summary style="font-weight:bold;"> Настройка </summary> <br />

1. В окне настроек интеграции сейчас есть 4 раздела: Главная, Открытые линии, Чаты, оффлайн заявки<br />


> Важно! 
> 
> После внесения настроек в любой из вкладок необходимо нажать кнопку "Сохранить" внизу экрана, чтобы изменения вступили в силу. Проверить то, что все сохранилось можно путем обновления вкладки браузера.
> 
> В каждом из разделов есть тоггл, который отображает, включен ли раздел или нет. Для корректной работы нужной части интеграции нужно следить, чтобы этот тоггл был активирован.<br />

2. Выберите необходимы и настройте их по своим предпочтениям.
  
> Помните!
> 
> Открытые Линии (далее ОЛ) **не могут** работать одновременно с активированными и настроенными чатами! Это связано с особенностью работы ОЛ Б24 с подключенными к ним каналами.
>
> При этом есть исключение, когда чаты и ОЛ включают специально, но все настройки внутри раздела чатов остаются отключенными. Это необходимо, если вы хотите работать не только с ОЛ Б24, но и с IFrame'ом нашего Рабочего Места Оператора в сущностях Битрикса. Детальнее вернемся к этому вопросу в разделе "Чаты". <br />
</details>

<details>
  <summary style="font-weight:bold;"> Вкладка Главная </summary> <br />


В данной вкладке доступна кнопка Ручная синхронизация - это синхронизация сущностей, необходимая для работы интеграции<br />
</details>
<details>
  <summary style="font-weight:bold;"> Вкладка Чаты </summary> <br />
    
#### Чаты

1. Выбор канала чатов, которые будет отслеживать интеграция<br />
2. Фильтр ответственных за чаты<br />
3. Ответственный по-умолчанию во всех остальных случаях<br />
4. Выбор создавать ли сущности при первичном или повторном обращении.<br />
5. Выбор какого типа сущности будут создаваться<br />
- Лид/Сделка
- Дело
- Лид/Сделка + Дело
6. Создание сущности при начале или завершении чатов оператором.<br />
7. Выбор передавать ли чаты без контактных данных.<br />
8. Выбор отправлять ли уведомления ответственному при создании сущности.<br />

#### Офлайн заявки

1. Фильтр ответственных за офлайн заявки<br />
2. Ответственный по-умолчанию во всех остальных случаях.<br />
3. Выбор создавать ли сущности при первичном или повторном обращении.<br />
4. Выбор какого типа сущности будут создаваться<br />
- Лид/Сделка
- Дело
- Лид/Сделка + Дело
5. Создание сущности при начале или завершении чатов оператором.<br />
6. Выбор отправлять ли уведомления ответственному при создании сущности.<br />

#### Фильтрация<br />

Отдельно фильтруются чаты и офлайн заявки. Также можно группировать фильтры при помощи операторов И/ИЛИ<br />

#### Сопоставление полей<br />

Можно сопоставить поле из API UIS с полем Битрикс24.<br />

![04_mapping.png](04_mapping.png)

</details>

<details>
  <summary style="font-weight:bold;"> Вкладка Открытые линии : сквозная аналитика </summary> <br />

1. Настройте **Webhook** в Битрикс24. <br /> 
  
<details>
  <summary style="font-weight:bold;"> Подробнее </summary> <br />  
  
   - Настройте исходящий веб-хук на событие "Создание лида (ONCRMLEADADD)" или "Создание сделки  (ONCRMINVOICEADD) в зависимости от того, какая сущность создается по факту чата
   - В поле "URL вашего обработчика" необходимо указать адрес из поля "Webhook url" из настройки интеграции.
  ![image](06_hook.gif)  
  
</details> 
<br />

2. Выбор сотрудника, который будет указан в переписке чата. <br />
3. Выбор типа трафика. <br />
4. В зависимости от выбранного **типа трафика** выводится либо список источников и сайтов, либо список рекламных кампаний. Используем в случае отсутствия сессии. <br /> 
5. Заполнение соответствия мессенджеров и источников/РК. <br />
6. После сохранения настроек будет выведен скрипт, который необходимо скопировать и установить на всех страницах сайта, где расположен виджет Открытых линий Битрикса24. Добавлять необходимо после кода вставки UIS.<br />

</details>

