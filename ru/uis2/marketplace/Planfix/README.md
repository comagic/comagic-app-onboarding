## Интеграция с Planfix  <br />  

**Ценность**   <br />

Решение позволяет передавать в наш кабинет данные по сделкам, для дальнейшего построения Сквозной аналитики, а также интегрировать функционал телефонии и передавать данные по звонкам и текстовым коммуникациям в Planfix   <br />

**Функциональность интеграции**  <br />
<details>
 <summary style="font-weight:bold;"> Подробнее </summary> <br />  
 Данные передаваемые по звонкам:  <br />

 - всплывающие уведомления о входящих звонках;  
 - исходящий звонок по клику из Planfix CRM;  
 - сохранение истории и записей звонков в Planfix CRM;
 - автоматическое создание контактов и задач при поступлении звонков;
 - передача дополнительных полей в контакты и/или задачи.


 <br />

Данные передаваемые по текстовым коммуникациям:  <br />  

- встроенное рабочее место оператора (РМО) для переписки в онлайн-чате, мессенджерах и соцсетях;  
- автоматическое создание контактов и задач при поступлении чатов и заявок;  
- передача дополнительных полей в контакты и/или задачи.

 <br />


 Данные получаемые по сделкам:    <br />  
 - сумма и статус сделки.
  <br />  

</details> 
<br />
<br />


**Подключение учетных записей**  <br />  
<br /> 

<details>
 <summary style="font-weight:bold;"> Шаги по подключению </summary> <br />

**Важно!** Прежде чем перейти к авторизации пользователя в нашем ЛК, необходимо [создать робота](https://planfix.com/ru/help/%D0%A0%D0%BE%D0%B1%D0%BE%D1%82%D1%8B_%D0%B2_%D0%9F%D0%BB%D0%B0%D0%BD%D0%A4%D0%B8%D0%BA%D1%81%D0%B5)  для запросов на стороне Planfix CRM. Это необходимо сделать из-за особенностей/ограничений работы CRM с сущностями в разрезе прав пользователей. 

После создания робота для запросов вернитесь в ЛК UIS, нажмите «Добавить учетные данные» и заполните поля в поле "Авторизация Rest API":  

 - Название:  произвольное, понятное вам;  
 - URL: берется из Planfix CRM по пути "Управление аккаунтом → Доступ к API → REST API → Адрес для API запросов";  
 - Bearer token: берется из Planfix CRM по тому же пути "Управление аккаунтом → Доступ к API → REST API → Создать новый токен → Токен авторизации.  

**Важно!** При создании нового токена необходимо в строке "Сотрудник/Контакт" выбрать ранее созданного вами робота для запросов, а так же убедиться в том, что в строке "Разрешенные Scope" выбраны все доступные параметры. Не забудьте сохранить настройки!


Из-за особенностей работы CRM для корректной настройки и работы телефонии нужна еще одна авторизация. Для этого необходимо в ЛК UIS кликнуть на "Авторизация для телефонии" → "Добавить учетные данные" и ввести:  

- Название: произвольное, понятное вам;  
- URL: берется из Planfix CRM по пути "Управление аккаунтом → Интеграции → Виртуальные АТС → найти и установить приложение "Api ПланФикса для телефоний";  
- Token: берется из Planfix CRM по тому же пути "Управление аккаунтом → Интеграции → Виртуальные АТС → приложение "Api ПланФикса для телефоний" → Ключ авторизации (token) ПланФикса;  

**Важно!** Если у вас уже подключено приложение "UIS" в маркетплейсе Planfix CRM, то его нужно отключить и оставить только "Api ПланФикса для телефоний". Не забудьте убедиться в том, что приложение "Api ПланФикса для телефоний" включено!

</details> 


<br />
<br />
<br />
<br />

## Синхронизация сотрудников <br />
<br /> 

<details>
 <summary style="font-weight:bold;"> Шаги по подключению </summary> <br />
 
Свитч активации **Синхронизация сотрудников** прожат по умолчанию для корректной работы всех компонентов интеграции. Выключение может привести к потери работоспособности.<br /> 
<br /> 

1. **Синхронизировать всех сотрудников** - выберите настройку, если требуется импортировать всех сотрудников из amoCRM в UIS. При выключенной настройке становится доступным список сотрудников для синхронизации.   <br />

2. Выберите конкретных сотрудников в настройке **Сотрудники для синхронизации**, если требуется синхронизировать не всех сотрудников из amoCRM.  <br /> 

3. Нажмите кнопку **Синхронизировать сотрудников** для ручной синхронизации сотрудников. <br />
При первом подключении интеграции обязательное действие.  <br /> 

4. Нажмите **Сохранить**.   <br />

**Важно!**  Если в Planfix CRM появился новый сотрудник, которого надо синхронизировать в UIS, то это необходимо сделать вручную по нажатию кнопки "Синхронизировать", после чего сотрудник станет доступен для выбора в настройке.

</details> 

## Телефония <br />
<br /> 

<details>
 <summary style="font-weight:bold;"> Шаги по подключению </summary> <br />

Для передачи данных по звонкам из UIS в Planfix прожмите свитч активации интеграции "Телефония".  <br /> 

<br />

## Основное <br /> 
<br />

1. **Фильтровать звонки** - данная настройка необходима для фильтрации звонков по определенным условиям. Если не использовать фильтр, то по всем звонкам будет создаваться сущность в CRM. При включении настройки станет доступно для выбора две поднастройки: "Фильтр входящих" и "Фильтр исходящих" звонков.Условия можно прописывать через операторы И/ИЛИ. Если фильтр настроен, то он будет помечен зеленой точкой в верхнем правом углу. Если вы нажали на чекбокс "Фильтровать звонки", но не выбрали никакую настройку в выпадающем списке - передаем все звонки.<br />

2. **Webhook URL** - Для корректной работы функционала необходимо скопировать Webhook URL и указать его по пути "Управление аккаунтом → Интеграции → Виртуальные АТС → приложение "Api ПланФикса для телефоний" → Адрес АТС .<br />

3. **Исходящий номер** - выберите, какой номер будет отражаться при звонке по клику. <br />

4. **Всегда отображать номер** - сли включить опцию, то правила отображения номера сотрудника будут игнорироваться и всегда будет отображаться выбранный номер. <br />  

5. **Входящие звонки** - перечень настроек для обработки входящих звонков. Ниже подробнее про возможные варианты: 
<br />  

 - **Первичные обращения** - выберите создавать ли задачу на первичное обращение. <br /> 

 - **Назначать на** - выберите, на какого сотрудника назначать созданую задачу. <br />   

 - **Повторные обращения** - выберите создавать ли задачу на повторное обращение.<br /> 

  - **Назначать на** - выберите, на какого сотрудника назначать созданую задачу. <br />   

   - **Объект задачи**  - выберите, по какому объекту необходимо создавать задачи. <br /> 
 
  - **Включить переадресацию на персонального менеджера** - активируйте, если необходима переадресация на персонального менеджера из CRM. Для работы необходим сценарий с данной операцией. <br />  
   **Важно!** Особенность интеграции с Planfix  в рамках телефонии заключается в том, что создание контактов, назначение отвественных за контакты, передача записей звонков осуществляется на стороне Planfix в соотвествии с настройкой приложения "Api ПланФикса для телефоний".<br />  

6. **Исходящие звонки** - перечень настроек для обработки исходящих звонков. Ниже подробнее про возможные варианты:  

 - **Первичные обращения** - выберите создавать ли задачу на первичное обращение. <br /> 

 - **Назначать на** - выберите, на какого сотрудника назначать созданую задачу. <br />   

 - **Повторные обращения** - выберите создавать ли задачу на повторное обращение.<br /> 

  - **Назначать на** - выберите, на какого сотрудника назначать созданую задачу. <br />   

  - **Объект задачи**  - выберите, по какому объекту необходимо создавать задачи. <br /> 
  
    **Важно!** Особенность интеграции с Planfix  в рамках телефонии заключается в том, что создание контактов, назначение отвественных за контакты, передача записей звонков осуществляется на стороне Planfix в соотвествии с настройкой приложения "Api ПланФикса для телефоний".<br />  

<br /> 
<br /> 

## Шаблоны <br />
<br /> 

В этом разделе вы можете настроить шаблон названий задач, которые будут автоматически создаваться в Planfix CRM при поступлении входящих или исходящих звонков, а так же отдельно для потерянных звонков.

1. Нажав на кнопку плюса, можно выбрать, какое значение переменной установить в шаблон наименования сущности. <br />   

2. Кнопка с иконкой (глаза) дает возможность сделать предпросмотр наименования которое будет отображено в создаваемой сущности. <br />   

3. Кнопка с иконкой (закругленой стрелочки) возвращает шаблон поля к последнему сохраненному значению. <br /> 
<br />


## Ответственные <br />  
<br /> 

Настройка позволяет управлять назначением ответственных сотрудников за сущности в зависимости от условий. <br />


1. Задайте ответственного по умолчанию - это обязательное поле. <br />

2. Для добавлении условия назначения ответственного нажмите кнопку "Добавить" в основных условиях. <br />
- Выберите сотрудника из выпадающего списка. 
- Далее выберите условия или группы условий для определения правил, по которым будут проставляться ответственные в создаваемых сущностях по обращениям.
- Нажмите "Сохранить". <br /> 


<br /> 
<br /> 

## Дополнительные поля <br />  
<br /> 

Настройка позволяет передавать дополнительные поля в контакт и задачу.

1. Сопоставьте для каждой сущности дополнительные поля из Planfix и UIS. 

2. При необходимости обновлять поля при каждом обращении прожмите **Обновлять всегда**.

3. После добавления сопоставления всех требуемых дополнительных полей - нажмите "Сохранить".<br />

<br /> 

</details> 

<br />
<br />
<br />
<br />

## Текстовые коммуникации <br />
<br /> 

<details>
 <summary style="font-weight:bold;"> Шаги по подключению </summary> <br />

Для передачи данных по чатам и заявкам из UIS в Planfix прожмите свитч активации интеграции "Текстовые коммуникации".  <br /> 

<br />

## Основное <br /> 
<br />

**Заявки**

1. **Фильтровать заявки** - данная настройка необходима для фильтрации заявок по определенным условиям. Если не использовать фильтр, то по всем заявкам будет создаваться сущность в CRM. Условия можно прописывать через операторы И/ИЛИ. Если фильтр настроен, то он будет помечен зеленой точкой в верхнем правом углу. Если вы нажали на чекбокс "Фильтровать заявки", но не выбрали никакую настройку в выпадающем списке - передаем все заявки.<br />  

2. **При первичных обращениях** - выберите, какие сущности необходимо создавать на первичное обращение.  

3. **Назначать на** - выберите, на какого сотрудника назначать созданые сущности. <br /> 

4. **При повторных обращениях** - выберите, какие сущности необходимо создавать на повторное обращение. 

5. **Назначать на** - выберите, на какого сотрудника назначать созданые сущности. <br /> 

6. **Шаблон контакта** - выберите, по какому шаблону создавать контакты.   

7. **Объект задачи** - выберите, по какому объекту создавать задачи. 


**Чаты** 

1. **Фильтровать чаты** - данная настройка необходима для фильтрации чатов по определенным условиям. Если не использовать фильтр, то по всем чатам будет создаваться сущность в CRM. Условия можно прописывать через операторы И/ИЛИ. Если фильтр настроен, то он будет помечен зеленой точкой в верхнем правом углу. Если вы нажали на чекбокс "Фильтровать чаты", но не выбрали никакую настройку в выпадающем списке - передаем все чаты.<br /> 

2. **При первичных обращениях** - выберите, какие сущности необходимо создавать на первичное обращение.  

3. **Назначать на** - выберите, на какого сотрудника назначать созданые сущности. <br /> 

4. **При повторных обращениях** - выберите, какие сущности необходимо создавать на повторное обращение. 

5. **Назначать на** - выберите, на какого сотрудника назначать созданые сущности. <br /> 

6. **Создавать контакт/задачу** - выберите, на какой момент чата необходимо создавать сущности.  

7. **Передавать чаты без контактных данных** - включите если необходимо передаваться чаты от посетителей, у которых отсутствует номер телефона. При каждом новом чате с посетителем без контактных данных будет создаваться новый контакт и задача, что может привести к дублям в Planfix CRM.

8. **Шаблон контакта** - выберите, по какому шаблону создавать контакты. 

9. **Объект задачи** - выберите, по какому объекту создавать задачи. 

<br /> 
<br /> 

## Шаблоны <br />
<br /> 

В этом разделе вы можете настроить шаблон названий контактов и  задач, которые будут автоматически создаваться в Planfix CRM при поступлении входящих или исходящих чатов и заявок.

1. Нажав на кнопку плюса, можно выбрать, какое значение переменной установить в шаблон наименования сущности. <br />   

2. Кнопка с иконкой (глаза) дает возможность сделать предпросмотр наименования которое будет отображено в создаваемой сущности. <br />   

3. Кнопка с иконкой (закругленой стрелочки) возвращает шаблон поля к последнему сохраненному значению. <br /> 
<br />


## Ответственные <br />  
<br /> 

Настройка позволяет управлять назначением ответственных сотрудников за сущности в зависимости от условий. <br />


1. Задайте ответственного по умолчанию - это обязательное поле. <br />

2. Для добавлении условия назначения ответственного нажмите кнопку "Добавить" в основных условиях. <br />
- Выберите сотрудника из выпадающего списка. 
- Далее выберите условия или группы условий для определения правил, по которым будут проставляться ответственные в создаваемых сущностях по обращениям.
- Нажмите "Сохранить". <br /> 


<br /> 
<br /> 

## Дополнительные поля <br />  
<br /> 

Настройка позволяет передавать дополнительные поля в контакт и задачу.

1. Сопоставьте для каждой сущности дополнительные поля из Planfix и UIS. 

2. При необходимости обновлять поля при каждом обращении прожмите **Обновлять всегда**.

3. После добавления сопоставления всех требуемых дополнительных полей - нажмите "Сохранить".<br />

<br /> 

</details> 

<br />
<br />
<br />
<br />


## Сделки <br />
<br /> 

<details>
 <summary style="font-weight:bold;"> Шаги по подключению </summary> <br />

Для передачи данных по сделкам из Planfix UIS в UIS прожмите свитч активации интеграции "Сделки".  <br /> 

<br />

Для корректной работы функционала часть настроек необходимо произвести на стороне Planfix CRM. Для этого необходимо перейти в Planfix CRM в "Управление аккаунтом → Объекты → выбрать нужный объект, который вы считаете за сущность "Сделка" и кликнуть на него → Автоматические сценарии → Новый сценарий".


В открывшемся окне необходимо задать название сценария, далее в пункте "Событие, при котором будет запущен сценарий" очень важно указать корректное событие, а именно: "Задача создана и соответсвует условиям". Ниже в п.4 настройки под названием "Выполнить следующие операции" выбираем "Послать HTTP-запрос", метод - POST, в URL указываем адрес, который берется из настроек интеграции в UIS в разделе "Передача сделок" далее Тип - application/json, в пункте "Содержание запроса" в "Параметре" необходимо указать task_id, а в "Значение" - {{Задача.Номер}}, после чего не забудьте сохранить изменения!

**ВАЖНО!** Убедитесь, что все настройки в точности соответствуют описанию инструкции, в противном случае передача сделок из Planfix CRM в UIS работать не будет!

После сохранения сценария нужно создать еще один, но уже с другим типом события. Для этого вернитесь в раздел "Автоматические сценарии" в Planfix CRM и создайте новый сценарий. У него должны быть следующие настройки:
Название сценария
Событие, при котором будет запущен сценарий - выберите "Задача изменена, но все еще соответствует условиям"
Ниже в п.4 настройки под названием "Выполнить следующие операции" выбираем "Послать HTTP-запрос", метод - POST, в URL указываем адрес, который берется из настроек интеграции в UIS в разделе "Передача сделок" далее Тип - application/json, в пункте "Содержание запроса" в "Параметре" необходимо указать  task_id, а в "Значение" - {{Задача.Номер}}

Итого у вас должно получиться 2 сценария, в которых будет отличаться пункт "Событие, при котором будет запущен сценарий".

В кабинете UIS необходимо выполнить следующие настройки:

1. **Выберите объект задач** - выберите объект, по которому выполнили настройку выше.  
2. **Выберите успешный этап задачи** - выберите статус задачи, которой соотвествует успешному этапу сделки.  

3. **Выберите провальный этап задачи** - выберите статус задачи, которой соотвествует провальному этапу сделки. 

4. **Выберите поле, в котором передается сумма сделки** - выберите поле, в котором вы записываете сумму сделки. Для выбора доступны только числовые поля задачи.

5. Нажмите сохранить.

</details> 

<br />
<br />
<br />
<br />
